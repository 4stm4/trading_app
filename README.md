# Trading System

## О проекте
Trading System — платформа для анализа инструментов, генерации торговых сигналов, бэктестинга и сравнения моделей. Система ориентирована на MOEX и FORTS, при этом архитектура рассчитана на подключение новых бирж без дублирования бизнес-логики.

Ключевой принцип: адаптеры отвечают за получение и нормализацию данных биржи, а вся торговая логика сосредоточена в едином стратегическом движке.

## Архитектура и слои
Проект разделен на независимые слои.
- `adapters` — интеграция с биржами и источниками данных.
- `services` — бизнес-логика и вычислительные сервисы.
- `services/strategy_engine` — центральный движок стратегий.
- `ports/cli` — универсальный пользовательский вход через CLI.
- `ports/api` — REST API для внешних клиентов.
- `frontend` — веб-интерфейс на Dash.
- `entities` — модели данных.
- `settings` — конфигурация приложения.

Архитектурные принципы.
- Универсальность: один strategy engine для разных бирж.
- Централизация: сигналы, риск и бэктест в одном месте.
- Разделение ответственности: адаптеры не содержат торговых правил.
- Расширяемость: новая биржа добавляется через новый адаптер.
- Поддерживаемость: изменения в логике вносятся централизованно.

## Поток данных
Общий поток обработки.
- Биржевой адаптер запрашивает OHLCV и служебные данные.
- Данные нормализуются и обогащаются индикаторами.
- Strategy Engine выполняет анализ структуры, фильтрацию, скоринг и риск-расчет.
- Пользователь получает сигнал, отчет бэктеста или сравнительную аналитику.

## MOEX Adapter
Назначение `adapters/moex`.
- Подключение к MOEX ISS API.
- Загрузка свечей, котировок и спецификаций инструментов.
- Подготовка датасета для стратегического движка.
- Диагностические утилиты качества данных.

Границы слоя адаптера.
- Допустимо: запросы к API, преобразование ответа, подготовка данных.
- Недопустимо: правила стратегии, риск-модель, оптимизация моделей, ядро бэктестинга.

Ключевые модули MOEX.
- `iss_client` — клиент ISS API.
- `indicator_dataset` — подготовка DataFrame с индикаторами.
- `cli_dataset_loader` — загрузка датасета для CLI и quality warnings.
- `setup_monitor` — мониторинг активных сетапов.
- `data_probe_cli` — диагностика рыночных данных.

## Strategy Engine
`services/strategy_engine` — универсальный модуль торговых вычислений.

Основные компоненты.
- `core` — ATR, структура рынка, расстояния до MA, объемная статистика.
- `signals` — генерация сигналов `long`, `short`, `none`.
- `models` — торговые профили и параметры моделей.
- `risk` и `risk_manager` — риск-менеджмент и размер позиции.
- `backtest` и `backtest_engine` — симуляция сделок, walk-forward, устойчивость.
- `conservative_v2` и адаптивные модули — скоринг и режимные ограничения.

Состояния структуры рынка.
- `uptrend`
- `downtrend`
- `range`
- `unknown`

Состояния фазы.
- `trend`
- `pullback`
- `range`
- `unknown`

Минимальные требования к данным.
- `open`
- `high`
- `low`
- `close`
- `volume`
- `ma50`
- `ma200`
- `rsi`
- временной индекс свечей

## Торговые модели
Поддерживаемые профили.
- `conservative`
- `high_rr`
- `balanced`
- `aggressive`
- `scalp`

Назначение профилей.
- `conservative` — более строгие фильтры и требования к качеству входа.
- `high_rr` — приоритет соотношения риск/прибыль.
- `balanced` — базовый профиль по умолчанию.
- `aggressive` — более мягкие фильтры и выше торговая активность.
- `scalp` — короткий профиль для высокой частоты сделок.

## Логика торговли верхнего уровня
- Анализ структуры рынка и контекста.
- Проверка фильтров тренда, отката, объема, RSI, ATR и quality scoring.
- Построение сделки с параметрами входа, стопа и цели.
- Расчет риска в деньгах и процентах.
- Контроль ограничений и защитных правил стратегии.

## Риск-менеджмент и бэктест
Поддерживаемые возможности.
- Расчет риск-параметров на сделку.
- Расчет позиции с учетом ограничений модели.
- Статистика сделок и капитала.
- Метрики Winrate, Profit Factor, Expectancy, Sharpe, Drawdown.
- Walk-forward проверка.
- Monte Carlo сценарии.
- Оценка устойчивости.
- Расчет риска разорения.

## Конфигурация
Система поддерживает конфигурацию из `strict.yaml` и fallback defaults.

Конфиг управляет следующими блоками.
- Volume-фильтры.
- Trend-фильтры.
- Pullback-ограничения.
- RSI и ATR параметры.
- Risk-ограничения.
- Regime-ограничения.
- Costs-параметры.
- Scoring-веса.
- Пороговые значения минимального RR.

## CLI
Универсальный CLI расположен в `ports/cli/trading_cli`.

Что поддерживает CLI.
- Анализ одного инструмента.
- Генерацию торгового сигнала.
- Запуск бэктеста.
- Оптимизацию и сравнение моделей.
- Многосимвольный режим.
- Walk-forward и Monte Carlo режимы.
- JSON-вывод.
- Режимы для акций и фьючерсов.
- Диагностику загрузки и качества данных через связанные утилиты.

## REST API
REST API расположен в `ports/api`.

Ключевые endpoints.
- `GET /api/health`
- `GET /api/models`
- `POST /api/signal`
- `POST /api/backtest`
- `POST /api/optimize`

Основные входные поля API.
- `ticker`
- `deposit`
- `timeframe`
- `model`
- `engine`
- `market`
- `board`

Типовые коды ответа.
- `200` — успешно.
- `400` — ошибка входных параметров.
- `404` — данные не найдены.
- `500` — внутренняя ошибка.

## Python API-клиент
В проекте есть готовый клиент в `ports/api/client`.

Он упрощает следующие операции.
- Проверка статуса API.
- Получение списка моделей.
- Запрос сигнала.
- Запуск бэктеста.
- Оптимизация моделей.

## Веб-интерфейс
`frontend` предоставляет интерактивный дашборд для анализа сигналов и результатов бэктеста.

Основные возможности.
- Свечной график.
- Визуализация MA50, MA200, RSI.
- Отображение входа, стопа и цели.
- Карточка сигнала с контекстом рынка.
- Экран результатов бэктеста.
- Настройки инструмента, таймфрейма, депозита, модели и типа рынка.

Технологический стек.
- Dash.
- Plotly.
- Pandas.
- Flask.

## Быстрый запуск (высокоуровнево)
- CLI: запуск из `ports.cli.trading_cli` с параметрами тикера, депозита и режима рынка.
- API: запуск `run_api.py` и работа через HTTP endpoints.
- Frontend: запуск `run_frontend.py` и работа через браузерный dashboard.

## Производительность
Типичные ориентиры.
- Генерация сигнала занимает секунды.
- Бэктест занимает несколько секунд в зависимости от объема данных.
- Оптимизация требует больше времени и зависит от числа моделей и режима проверки.

## Безопасность и эксплуатация
По умолчанию интерфейсы ориентированы на локальное или защищенное окружение.

Для production рекомендуется.
- Аутентификация запросов.
- Шифрование транспортного канала.
- Ограничение частоты запросов.
- Сетевая изоляция сервисов.
- Централизованный мониторинг и логирование.

## Troubleshooting
Типовые причины проблем.
- Некорректный тикер или несоответствие `engine` и `market`.
- Недостаточный исторический период данных.
- Неподходящий таймфрейм для выбранной модели.
- Конфликты портов при запуске API и frontend.

Практический порядок проверки.
- Проверить доступность API и источника данных.
- Проверить параметры инструмента и рынка.
- Увеличить исторический диапазон.
- Повторить запуск на более стабильном таймфрейме.

## Развитие
План развития.
- Расширение многобиржевой поддержки.
- Усиление аналитических отчетов.
- Дополнительные возможности визуализации и экспорта.
- Улучшение мониторинга и уведомлений.
- Дальнейшее повышение устойчивости моделей.

## Статус
Система находится в production-ready состоянии в рамках текущего объема проекта и продолжает развиваться.
